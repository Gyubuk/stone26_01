<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Round {{ round_no }}</title>
</head>
<body>
  <h1>경매 참여 화면</h1>
  <p>Round {{ round_no }} / {{ max_round }}</p>

  <ul>
    <li>즉시구매가 Ps: {{ Ps }}</li>
    <li>최저입찰가 k: {{ k }}</li>
    <li>수수료 c(입찰 낙찰 시): {{ c }}</li>
  </ul>

  {% if error %}
    <p style="color:red;">{{ error }}</p>
  {% endif %}

  <form method="POST" id="auctionForm">
    {% csrf_token %}

    <h3>선택</h3>
    <button type="submit" name="decision" value="buy">즉시구매</button>

    <hr>

    <h3>입찰</h3>

    <!-- 현재 값 표시 -->
    <p>
      현재 입찰가:
      <b id="bidDisplay">{{ default_bid }}</b>
    </p>

    <!-- 서버로 보내는 실제 값 -->
    <input type="hidden" name="bid_value" id="bidValue" value="{{ default_bid }}">

    <!-- 스텝퍼 버튼 -->
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button type="button" data-delta="-10000">-10,000</button>
      <button type="button" data-delta="-1000">-1,000</button>
      <button type="button" data-delta="1000">+1,000</button>
      <button type="button" data-delta="10000">+10,000</button>
    </div>

    <p style="margin-top:10px; color:#666;">
      범위: {{ k }} ~ {{ Ps }} / 단위: {{ step }}
    </p>

    <button type="submit" name="decision" value="bid">입찰하기</button>
  </form>

  <script>
    (function(){
      const min = Number("{{ k }}");
      const max = Number("{{ Ps }}");
      const step = Number("{{ step }}");

      const display = document.getElementById("bidDisplay");
      const input = document.getElementById("bidValue");
      const buttons = document.querySelectorAll("button[data-delta]");

      function clampAndSnap(v){
        // step에 맞추기
        v = Math.round(v / step) * step;
        // 범위 제한
        v = Math.max(min, Math.min(max, v));
        return v;
      }

      function setValue(v){
        const vv = clampAndSnap(v);
        input.value = String(vv);
        display.textContent = vv.toLocaleString();
      }

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const delta = Number(btn.getAttribute("data-delta"));
          setValue(Number(input.value) + delta);
        });
      });

      // 초기 표시
      setValue(Number(input.value));
    })();
  </script>
</body>
</html>
