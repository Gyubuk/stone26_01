{% extends 'base.html' %}
{% load static %}

{% block title %}실험 {{ exp_no }}의 {{ round_no }}{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Noto Sans KR', sans-serif;
    background-color: #f8f9fa;
  }

  @keyframes bidPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); color: #2563eb; }
  }
  .value-changed {
    animation: bidPulse 0.3s ease-in-out;
  }

  @keyframes slideInRight {
    from { transform: translateX(110%); opacity: 0; }
    to   { transform: translateX(0);    opacity: 1; }
  }
  @keyframes slideOutRight {
    from { transform: translateX(0);    opacity: 1; }
    to   { transform: translateX(110%); opacity: 0; }
  }
  .toast-slide-in  { animation: slideInRight 0.3s ease-out forwards; }
  .toast-slide-out { animation: slideOutRight 0.3s ease-in forwards; }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }
  @keyframes scaleIn {
    from { transform: scale(0.92); opacity: 0; }
    to   { transform: scale(1);    opacity: 1; }
  }
  .modal-overlay { animation: fadeIn 0.2s ease-out forwards; }
  .modal-box     { animation: scaleIn 0.2s ease-out forwards; }

  .btn-buy:hover  { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(22,163,74,0.2); }
  .btn-bid:hover  { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(37,99,235,0.2); }
  .stepper-btn:hover { transform: scale(1.04); }
  .stepper-btn:active { transform: scale(0.97); }
  .price-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }

  .progress-fill {
    transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-20" style="font-family: 'Noto Sans KR', sans-serif;">

  <!-- 상단 헤더 -->
  <div class="bg-white border-b border-gray-200 py-4 px-6 flex items-center shadow-sm">
    <div class="flex items-center gap-2 text-gray-700 font-bold">
      <i class="fas fa-box text-gray-500"></i>
      <span>온라인 경매 상황에서의 구매 의사결정 실험</span>
    </div>
    <div class="ml-2 text-xs text-gray-400 font-medium">MRA Lab @ SSU</div>
  </div>

  <div class="max-w-3xl mx-auto px-4 pt-8">

    <!-- 에러 메시지 -->
    {% if messages %}
      {% for message in messages %}
      <div class="mb-4 bg-red-50 border border-red-200 text-red-700 rounded-xl px-5 py-4 flex items-center gap-3">
        <i class="fas fa-exclamation-circle text-red-500"></i>
        <span class="font-medium">{{ message }}</span>
      </div>
      {% endfor %}
    {% endif %}

    <!-- 상태 바: 상품 + 라운드 -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 flex justify-between items-center px-6 py-5 mb-6">
      <div class="flex items-center gap-4">
        <div class="bg-gray-100 p-3 rounded-xl">
          <i class="fas fa-shopping-bag text-gray-700 text-xl"></i>
        </div>
        <div>
          <p class="text-xs text-gray-400 font-bold mb-0.5 uppercase tracking-wide">상품</p>
          <p class="font-bold text-gray-900 text-lg">{{ participant.product }}</p>
        </div>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-400 font-bold mb-0.5 uppercase tracking-wide">실험 {{ exp_no }} · Round</p>
        <div class="flex items-baseline justify-end gap-1">
          <span class="font-black text-blue-600 text-4xl leading-none">{{ round_no }}</span>
          <span class="text-gray-400 font-medium text-lg">/ {{ max_round }}</span>
        </div>
      </div>
    </div>

    <!-- 라운드 프로그레스바 -->
    <div class="mb-8">
      <div class="w-full bg-gray-200 rounded-full h-2 relative">
        <div class="progress-fill h-2 rounded-full {% if round_no == max_round %}bg-red-500{% else %}bg-blue-600{% endif %}"
             style="width: {{ round_no }}0%"></div>
      </div>
      <div class="flex justify-between text-xs text-gray-400 mt-2 font-mono">
        <span>Round 1</span>
        <span class="{% if round_no == max_round %}text-red-500 font-bold{% endif %}">Round {{ max_round }} (종료)</span>
      </div>
    </div>

    <!-- 가격 카드 3종 -->
    <div class="grid grid-cols-3 gap-4 mb-8">
      <div class="price-card bg-white rounded-2xl border border-gray-200 p-5 text-center transition-all duration-200 cursor-default">
        <p class="text-xs text-gray-400 font-bold uppercase tracking-wide mb-2">즉시구매가</p>
        <p class="text-3xl font-black text-emerald-600 leading-none">{{ Ps|floatformat:0 }}</p>
        <p class="text-xs text-gray-400 mt-1 font-medium">원</p>
      </div>
      <div class="price-card bg-white rounded-2xl border border-gray-200 p-5 text-center transition-all duration-200 cursor-default">
        <p class="text-xs text-gray-400 font-bold uppercase tracking-wide mb-2">최저입찰가</p>
        <p class="text-3xl font-black text-amber-500 leading-none">{{ k|floatformat:0 }}</p>
        <p class="text-xs text-gray-400 mt-1 font-medium">원</p>
      </div>
      <div class="price-card bg-white rounded-2xl border border-gray-200 p-5 text-center transition-all duration-200 cursor-default">
        <p class="text-xs text-gray-400 font-bold uppercase tracking-wide mb-2">수수료</p>
        <p class="text-3xl font-black text-red-500 leading-none">{{ c|floatformat:0 }}</p>
        <p class="text-xs text-gray-400 mt-1 font-medium">원</p>
      </div>
    </div>

    <!-- 선택 카드: 즉시구매 / 입찰 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

      <!-- 즉시구매 -->
      <form method="POST" action="{% url 'experiments:make_choice' %}">
        {% csrf_token %}
        <input type="hidden" name="exp_no" value="{{ exp_no }}">
        <input type="hidden" name="round_no" value="{{ round_no }}">
        <button type="submit" name="decision" value="buy"
                class="btn-buy w-full bg-white border-2 border-gray-200 hover:border-emerald-500 hover:bg-emerald-50/30 rounded-2xl p-7 text-left flex flex-col transition-all duration-200 group">
          <div class="bg-emerald-100 p-3 rounded-full w-fit mb-5 text-emerald-600 group-hover:bg-emerald-200 transition-colors">
            <i class="fas fa-check text-xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">Option 1. 즉시 구매하기</h3>
          <p class="text-gray-500 text-sm leading-relaxed font-medium mb-5">
            경매 없이 제시된 가격으로 바로 구매하고 해당 회차를 종료합니다.
          </p>
          <div class="w-full border-t border-gray-100 pt-5 mt-auto">
            <p class="text-xs text-gray-400 font-bold mb-1">판매자 제시 가격</p>
            <p class="text-3xl font-black text-gray-900">
              {{ Ps|floatformat:0 }}<span class="text-base font-normal text-gray-500 ml-1">원</span>
            </p>
          </div>
        </button>
      </form>

      <!-- 입찰 -->
      <button type="button" id="openBidModal"
              class="btn-bid w-full bg-white border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50/30 rounded-2xl p-7 text-left flex flex-col transition-all duration-200 group">
        <div class="bg-blue-100 p-3 rounded-full w-fit mb-5 text-blue-600 group-hover:bg-blue-200 transition-colors">
          <i class="fas fa-gavel text-xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Option 2. 입찰 참여하기</h3>
        <p class="text-gray-500 text-sm leading-relaxed font-medium mb-5">
          원하는 가격을 제안합니다. 기준 미달 시 유찰되며 라운드가 소모됩니다.
        </p>
        <div class="w-full border-t border-gray-100 pt-5 mt-auto flex justify-between items-end">
          <div>
            <p class="text-xs text-gray-400 font-bold mb-1">현재 최저 입찰 가능가</p>
            <p class="text-3xl font-black text-blue-600">
              {{ k|floatformat:0 }}<span class="text-base font-normal text-gray-500 ml-1">원</span>
            </p>
          </div>
          <div class="bg-blue-100 p-2 rounded-full text-blue-600">
            <i class="fas fa-arrow-right"></i>
          </div>
        </div>
      </button>

    </div>
  </div>
</div>

<!-- ========== 입찰 모달 ========== -->
<div id="bidModal" class="modal-overlay hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
  <div class="modal-box bg-white rounded-2xl w-full max-w-md shadow-2xl">

    <div class="flex items-center justify-between px-7 py-5 border-b border-gray-100">
      <div class="flex items-center gap-2 font-bold text-gray-900 text-lg">
        <i class="fas fa-gavel text-blue-600"></i>
        입찰가 설정
      </div>
      <button id="closeBidModal" class="text-gray-400 hover:text-gray-600 transition-colors text-xl w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="px-7 py-6">
      <div class="text-center mb-6">
        <p class="text-xs text-gray-400 font-bold uppercase tracking-wide mb-2">현재 입찰가</p>
        <div class="flex items-baseline justify-center gap-1">
          <span id="bidDisplay" class="text-5xl font-black text-gray-900 inline-block transition-all">{{ k|floatformat:0 }}</span>
          <span class="text-lg text-gray-400 font-medium">원</span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-5">
        <button type="button"
                class="stepper-btn border border-red-200 text-red-600 bg-red-50 hover:bg-red-100 rounded-xl py-3 font-bold text-sm transition-all duration-150 flex items-center justify-center gap-1"
                data-delta="-10000">
          <i class="fas fa-minus-circle"></i> 10,000
        </button>
        <button type="button"
                class="stepper-btn border border-emerald-200 text-emerald-600 bg-emerald-50 hover:bg-emerald-100 rounded-xl py-3 font-bold text-sm transition-all duration-150 flex items-center justify-center gap-1"
                data-delta="10000">
          <i class="fas fa-plus-circle"></i> 10,000
        </button>
        <button type="button"
                class="stepper-btn border border-red-200 text-red-400 bg-red-50/60 hover:bg-red-100 rounded-xl py-2.5 font-bold text-sm transition-all duration-150 flex items-center justify-center gap-1"
                data-delta="-1000">
          <i class="fas fa-minus"></i> 1,000
        </button>
        <button type="button"
                class="stepper-btn border border-emerald-200 text-emerald-400 bg-emerald-50/60 hover:bg-emerald-100 rounded-xl py-2.5 font-bold text-sm transition-all duration-150 flex items-center justify-center gap-1"
                data-delta="1000">
          <i class="fas fa-plus"></i> 1,000
        </button>
      </div>

      <div class="bg-gray-50 rounded-xl px-4 py-3 text-xs text-gray-500 leading-relaxed">
        <i class="fas fa-info-circle text-gray-400 mr-1"></i>
        범위: <strong class="text-gray-700">{{ k|floatformat:0 }}</strong> ~ <strong class="text-gray-700">{{ Ps|floatformat:0 }}</strong>원
        &nbsp;|&nbsp; 단위: <strong class="text-gray-700">{{ step|floatformat:0 }}</strong>원<br>
        낙찰 시 총 비용: <strong class="text-gray-700">입찰가 + {{ c|floatformat:0 }}원(수수료)</strong>
      </div>
    </div>

    <div class="flex gap-3 px-7 pb-6">
      <button id="cancelBidModal"
              class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50 transition-colors">
        취소
      </button>
      <button id="bidSubmitBtn"
              class="flex-2 flex-grow-[2] py-3 px-6 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
        <i class="fas fa-gavel"></i> 입찰하기
      </button>
    </div>

  </div>
</div>

<!-- 토스트 컨테이너 -->
<div id="toastContainer" class="fixed top-20 right-5 z-[9999] flex flex-col gap-2 max-w-xs w-full"></div>

{% endblock %}

{% block extra_js %}
<script>
(function() {
  'use strict';

  // ── 설정 ──────────────────────────────────────────
  const config = {
    min:        Number("{{ k }}"),
    max:        Number("{{ Ps }}"),
    step:       Number("{{ step }}"),
    commission: Number("{{ c }}"),
    exp_no:     Number("{{ exp_no }}"),
    round_no:   Number("{{ round_no }}")
  };

  // ── DOM ───────────────────────────────────────────
  const modal      = document.getElementById('bidModal');
  const openBtn    = document.getElementById('openBidModal');
  const closeBtn   = document.getElementById('closeBidModal');
  const cancelBtn  = document.getElementById('cancelBidModal');
  const display    = document.getElementById('bidDisplay');
  const submitBtn  = document.getElementById('bidSubmitBtn');
  const stepperBtns = document.querySelectorAll('.stepper-btn');

  let currentBid = config.min;

  // ── 유틸 ──────────────────────────────────────────
  function clampAndSnap(value) {
    value = Math.round(value / config.step) * config.step;
    return Math.max(config.min, Math.min(config.max, value));
  }

  function updateDisplay() {
    display.textContent = currentBid.toLocaleString();
    display.classList.add('value-changed');
    setTimeout(() => display.classList.remove('value-changed'), 300);
  }

  function showToast(message, type = 'warning') {
    const container = document.getElementById('toastContainer');
    const colorMap = {
      warning: { border: 'border-l-amber-400',   icon: 'text-amber-500',   fa: 'fa-exclamation-triangle' },
      error:   { border: 'border-l-red-400',     icon: 'text-red-500',     fa: 'fa-times-circle' },
      success: { border: 'border-l-emerald-400', icon: 'text-emerald-500', fa: 'fa-check-circle' },
    };
    const c = colorMap[type] || colorMap.warning;
    const toast = document.createElement('div');
    toast.className = `toast-slide-in bg-white border border-gray-100 ${c.border} border-l-4 rounded-xl shadow-lg px-4 py-3 flex items-start gap-3`;
    toast.innerHTML = `
      <i class="fas ${c.fa} ${c.icon} mt-0.5 shrink-0"></i>
      <span class="flex-1 text-sm text-gray-700 font-medium leading-relaxed">${message}</span>
      <button class="text-gray-300 hover:text-gray-500 transition-colors shrink-0 mt-0.5" onclick="this.closest('div').remove()">
        <i class="fas fa-times text-xs"></i>
      </button>
    `;
    container.appendChild(toast);
    setTimeout(() => {
      toast.classList.remove('toast-slide-in');
      toast.classList.add('toast-slide-out');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // ── 모달 열기/닫기 ────────────────────────────────
  function openModal() {
    currentBid = config.min;
    updateDisplay();
    modal.classList.remove('hidden');
  }
  function closeModal() {
    modal.classList.add('hidden');
  }

  openBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) closeModal();
  });

  // ── 스텝퍼 버튼 ───────────────────────────────────
  stepperBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const delta = Number(this.getAttribute('data-delta'));
      const newVal = clampAndSnap(currentBid + delta);
      if (newVal !== currentBid) {
        currentBid = newVal;
        updateDisplay();
      } else {
        showToast(
          currentBid + delta < config.min
            ? `최저입찰가는 ${config.min.toLocaleString()}원입니다.`
            : `최대입찰가는 ${config.max.toLocaleString()}원입니다.`,
          'warning'
        );
      }
    });
  });

  // ── 입찰 제출 ─────────────────────────────────────
  submitBtn.addEventListener('click', function() {
    const confirmMsg =
      `${currentBid.toLocaleString()}원으로 입찰하시겠습니까?\n\n` +
      `낙찰 시 총 비용: ${(currentBid + config.commission).toLocaleString()}원`;

    if (!confirm(confirmMsg)) return;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/exp/make_choice/';

    const csrfMatch = document.cookie.match(/csrftoken=([^;]+)/);
    const fields = {
      'exp_no':            config.exp_no,
      'round_no':          config.round_no,
      'decision':          'bid',
      'bid_value':         currentBid,
      'csrfmiddlewaretoken': csrfMatch ? csrfMatch[1] : ''
    };

    Object.entries(fields).forEach(([name, value]) => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = name;
      input.value = value;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
  });

  // ── 초기화 ────────────────────────────────────────
  updateDisplay();

})();
</script>
{% endblock %}